# useEffect

useEffect æ˜¯ä¸€ä¸ª React Hookï¼Œå¯è®©æ‚¨å°†ç»„ä»¶ä¸Žå¤–éƒ¨ç³»ç»ŸåŒæ­¥ã€‚

``` javascript
useEffect(setup, dependencies)
```

## è¿žæŽ¥åˆ°å¤–éƒ¨ç³»ç»Ÿ

æŸäº›ç»„ä»¶åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæ—¶éœ€è¦ä¿æŒä¸Žç½‘ç»œã€æŸäº›æµè§ˆå™¨ API æˆ–ç¬¬ä¸‰æ–¹åº“çš„è¿žæŽ¥ã€‚è¿™äº›ç³»ç»Ÿä¸å— React æŽ§åˆ¶ï¼Œå› æ­¤å®ƒä»¬è¢«ç§°ä¸ºå¤–éƒ¨ç³»ç»Ÿã€‚

- å…·æœ‰ç±»ä¼¼ animation.start() å’Œ animation.reset() çš„ API çš„ç¬¬ä¸‰æ–¹åŠ¨ç”»åº“ã€‚
- æµè§ˆå™¨äº‹ä»¶
- è§¦å‘åŠ¨ç”»
- æŽ§åˆ¶æ¨¡å¼å¯¹è¯æ¡†
- è·Ÿè¸ªå…ƒç´ å¯è§æ€§

``` javascript
import { useEffect } from 'react';
import { createConnection } from './chat.js';

function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  useEffect(() => {
  	const connection = createConnection(serverUrl, roomId);
    connection.connect();
  	return () => {
      connection.disconnect();
  	};
  }, [serverUrl, roomId]);
  // ...
}
```

**React åœ¨å¿…è¦æ—¶è°ƒç”¨ä½ çš„è®¾ç½®å’Œæ¸…ç†å‡½æ•°ï¼Œè¿™å¯èƒ½ä¼šå‘ç”Ÿå¤šæ¬¡ï¼š**

- å½“æ‚¨çš„ç»„ä»¶æ·»åŠ åˆ°é¡µé¢ï¼ˆè£…è½½ï¼‰æ—¶ï¼Œæ‚¨çš„è®¾ç½®ä»£ç å°†è¿è¡Œã€‚
- æ¯æ¬¡é‡æ–°æ¸²æŸ“ä¾èµ–é¡¹å·²æ›´æ”¹çš„ç»„ä»¶åŽï¼š
    - é¦–å…ˆï¼Œæ¸…ç†ä»£ç ä½¿ç”¨æ—§çš„ props å’Œ state è¿è¡Œã€‚
    - ç„¶åŽï¼Œæ‚¨çš„è®¾ç½®ä»£ç å°†ä½¿ç”¨æ–°çš„ props å’Œ state è¿è¡Œã€‚
- ä»Žé¡µé¢ä¸­åˆ é™¤ç»„ä»¶ï¼ˆå¸è½½ï¼‰åŽï¼Œæ¸…ç†ä»£ç æœ€åŽä¸€æ¬¡è¿è¡Œã€‚

**è®©æˆ‘ä»¬åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­è¯´æ˜Žæ­¤åºåˆ—ã€‚**

å½“ä¸Šé¢çš„ ChatRoom ç»„ä»¶è¢«æ·»åŠ åˆ°é¡µé¢æ—¶ï¼Œå®ƒå°†è¿žæŽ¥åˆ°å¸¦æœ‰é¦–å­—æ¯ serverUrl å’Œ roomId çš„èŠå¤©å®¤ã€‚å¦‚æžœç”±äºŽé‡æ–°æ¸²æŸ“è€Œå‘ç”Ÿ roomId ä»»ä½• serverUrl å˜åŒ–ï¼ˆä¾‹å¦‚ï¼Œå¦‚æžœç”¨æˆ·åœ¨ä¸‹æ‹‰åˆ—è¡¨ä¸­é€‰æ‹©å…¶ä»–èŠå¤©å®¤ï¼‰ï¼Œåˆ™æ•ˆæžœå°†ä¸Žå‰ä¸€ä¸ªèŠå¤©å®¤æ–­å¼€è¿žæŽ¥ï¼Œå¹¶è¿žæŽ¥åˆ°ä¸‹ä¸€ä¸ªèŠå¤©å®¤ã€‚ä»Žé¡µé¢ä¸­åˆ é™¤ç»„ä»¶ ChatRoom åŽï¼Œæ‚¨çš„æ•ˆæžœå°†æœ€åŽä¸€æ¬¡æ–­å¼€è¿žæŽ¥ã€‚

ä¸ºäº†å¸®åŠ©ä½ å‘çŽ°é”™è¯¯ï¼Œåœ¨å¼€å‘ä¸­ï¼ŒReact åœ¨è®¾ç½®ä¹‹å‰é¢å¤–è¿è¡Œä¸€æ¬¡å®‰è£…å’Œæ¸…ç†ã€‚è¿™æ˜¯ä¸€é¡¹åŽ‹åŠ›æµ‹è¯•ï¼Œç”¨äºŽéªŒè¯æ•ˆæžœçš„é€»è¾‘æ˜¯å¦æ­£ç¡®å®žçŽ°ã€‚å¦‚æžœè¿™ä¼šå¯¼è‡´æ˜Žæ˜¾çš„é—®é¢˜ï¼Œåˆ™æ‚¨çš„æ¸…ç†åŠŸèƒ½ç¼ºå°‘ä¸€äº›é€»è¾‘ã€‚æ¸…ç†åŠŸèƒ½åº”åœæ­¢æˆ–æ’¤æ¶ˆè®¾ç½®åŠŸèƒ½æ­£åœ¨æ‰§è¡Œçš„ä»»ä½•æ“ä½œã€‚ç»éªŒæ³•åˆ™æ˜¯ï¼Œç”¨æˆ·ä¸åº”èƒ½å¤ŸåŒºåˆ†è°ƒç”¨ä¸€æ¬¡çš„è®¾ç½®ï¼ˆå¦‚åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­ï¼‰å’Œè®¾ç½®â†’æ¸…ç†â†’è®¾ç½®åºåˆ—ï¼ˆå¦‚åœ¨å¼€å‘ä¸­ï¼‰ã€‚æŸ¥çœ‹å¸¸è§è§£å†³æ–¹æ¡ˆã€‚

å°è¯•å°†æ¯ä¸ªæ•ˆæžœç¼–å†™ä¸ºä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œå¹¶ä¸€æ¬¡è€ƒè™‘ä¸€ä¸ªè®¾ç½®/æ¸…ç†å‘¨æœŸã€‚æ— è®ºæ‚¨çš„ç»„ä»¶æ˜¯æŒ‚è½½ã€æ›´æ–°è¿˜æ˜¯å¸è½½ï¼Œéƒ½æ— å…³ç´§è¦ã€‚å½“æ‚¨çš„æ¸…ç†é€»è¾‘æ­£ç¡®åœ°â€œé•œåƒâ€è®¾ç½®é€»è¾‘æ—¶ï¼Œæ‚¨çš„ Effect å¯ä»¥æ ¹æ®éœ€è¦çµæ´»åœ°è¿è¡Œè®¾ç½®å’Œæ¸…ç†ã€‚

## è‡ªå®šä¹‰é’©å­ä¸­çš„åŒ…è£…æ•ˆæžœ

ä¾‹å¦‚ï¼Œè¿™ä¸ª useChatRoom è‡ªå®šä¹‰ Hook å°† Effect çš„é€»è¾‘â€œéšè—â€åœ¨æ›´å…·å£°æ˜Žæ€§çš„ API åŽé¢ï¼š

``` javascript
function useChatRoom({ serverUrl, roomId }) {
  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId
    };
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]);
}
```

``` javascript
function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState('https://localhost:1234');

  useChatRoom({
    roomId: roomId,
    serverUrl: serverUrl
  });
  // ...
}
```

## æŽ§åˆ¶éž React å°éƒ¨ä»¶

æœ‰æ—¶ï¼Œæ‚¨å¸Œæœ›ä½¿å¤–éƒ¨ç³»ç»Ÿä¸Žç»„ä»¶çš„æŸä¸ªå±žæ€§æˆ–çŠ¶æ€ä¿æŒåŒæ­¥ã€‚

ä¾‹å¦‚ï¼Œå¦‚æžœä½ æœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹åœ°å›¾å°éƒ¨ä»¶æˆ–ä¸€ä¸ªæ²¡æœ‰ React ç¼–å†™çš„è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ Effect è°ƒç”¨å…¶æ–¹æ³•ï¼Œä½¿å…¶çŠ¶æ€ä¸Ž React ç»„ä»¶çš„å½“å‰çŠ¶æ€ç›¸åŒ¹é…ã€‚æ­¤æ•ˆæžœåˆ›å»º ä¸­ map-widget.js å®šä¹‰çš„ MapWidget ç±»çš„å®žä¾‹ã€‚å½“æ‚¨æ›´æ”¹ Map ç»„ä»¶çš„ zoomLevel prop æ—¶ï¼ŒEffect ä¼šè°ƒç”¨ setZoom() on ç±»å®žä¾‹ä»¥ä¿æŒå…¶åŒæ­¥ï¼š

``` javascript
import { useRef, useEffect } from 'react';
import { MapWidget } from './map-widget.js';

export default function Map({ zoomLevel }) {
  const containerRef = useRef(null);
  const mapRef = useRef(null);

  useEffect(() => {
    if (mapRef.current === null) {
      mapRef.current = new MapWidget(containerRef.current);
    }

    const map = mapRef.current;
    map.setZoom(zoomLevel);
  }, [zoomLevel]);

  return (
    <div
      style={{ width: 200, height: 200 }}
      ref={containerRef}
    />
  );
}
```

## ä½¿ç”¨æ•ˆæžœèŽ·å–æ•°æ®

æ‚¨å¯ä»¥ä½¿ç”¨ Effect æ¥èŽ·å–ç»„ä»¶çš„æ•°æ®ã€‚è¯·æ³¨æ„ï¼Œå¦‚æžœæ‚¨ä½¿ç”¨æ¡†æž¶ï¼Œä½¿ç”¨æ¡†æž¶çš„æ•°æ®èŽ·å–æœºåˆ¶å°†æ¯”æ‰‹åŠ¨ç¼–å†™ Effects é«˜æ•ˆå¾—å¤šã€‚

``` javascript
import { useState, useEffect } from 'react';
import { fetchBio } from './api.js';

export default function Page() {
  const [person, setPerson] = useState('Alice');
  const [bio, setBio] = useState(null);
  useEffect(() => {
    let ignore = false;
    setBio(null);
    fetchBio(person).then(result => {
      if (!ignore) {
        setBio(result);
      }
    });
    return () => {
      ignore = true;
    }
  }, [person]);

  return (
    <>
      <select value={person} onChange={e => {
        setPerson(e.target.value);
      }}>
        <option value="Alice">Alice</option>
        <option value="Bob">Bob</option>
        <option value="Taylor">Taylor</option>
      </select>
      <hr />
      <p><i>{bio ?? 'Loading...'}</i></p>
    </>
  );
}
```

## æŒ‡å®šååº”å¼ä¾èµ–å…³ç³»

æ³¨æ„ï¼Œæ‚¨ä¸èƒ½â€œé€‰æ‹©â€æ•ˆæžœçš„ä¾èµ–é¡¹ã€‚Effect ä»£ç ä½¿ç”¨çš„æ¯ä¸ªå“åº”å¼å€¼éƒ½å¿…é¡»å£°æ˜Žä¸ºä¾èµ–é¡¹ã€‚æ•ˆæžœçš„ä¾èµ–é¡¹åˆ—è¡¨ç”±å‘¨å›´çš„ä»£ç å†³å®šï¼š

``` javascript
function ChatRoom({ roomId }) { // This is a reactive value
  const [serverUrl, setServerUrl] = useState('https://localhost:1234'); // This is a reactive value too

  useEffect(() => {
    const connection = createConnection(serverUrl, roomId); // This Effect reads these reactive values
    connection.connect();
    return () => connection.disconnect();
  }, [serverUrl, roomId]); // âœ… So you must specify them as dependencies of your Effect
  // ...
}
```

## æ ¹æ®æ•ˆæžœçš„å…ˆå‰çŠ¶æ€æ›´æ–°çŠ¶æ€

å½“æ‚¨æƒ³è¦æ ¹æ® Effect çš„å…ˆå‰çŠ¶æ€æ›´æ–°çŠ¶æ€æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°ä»¥ä¸‹é—®é¢˜ï¼š

``` javascript
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const intervalId = setInterval(() => {
      setCount(count + 1); // You want to increment the counter every second...
    }, 1000)
    return () => clearInterval(intervalId);
  }, [count]); // ðŸš© ... but specifying `count` as a dependency always resets the interval.
  // ...
}
```

``` javascript
import { useState, useEffect } from 'react';

export default function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const intervalId = setInterval(() => {
      setCount(c => c + 1); // âœ… Pass a state updater
    }, 1000);
    return () => clearInterval(intervalId);
  }, []); // âœ… Now count is not a dependency

  return <h1>{count}</h1>;
}
```